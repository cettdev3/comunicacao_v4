{% extends 'menu.html' %}
{% load static %}
{% block content %}
<style>
.file-icon {
    font-size: 24px;
    margin-right: 10px;
}

.remove-button {
    cursor: pointer;
    color: red;
}


</style>
<div class="content-page">
    <div class="content">

        <!-- Start Content-->
        <div class="container-fluid">

            <div class="row">
                <div class="col-12">
                    <div class="page-title-box justify-content-between d-flex align-items-lg-center flex-lg-row flex-column">     
                        <h4 class="page-title">Gestão de Usuários</h4>
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item active">Controle de Usuários</li>
                        </ol>
                    </div>
                </div>
            </div> 
            
            <div class="col-md-12">
                <div class="card">
                    <h5 class="card-header bg-info-subtle">Cadastro de Usuário</h5>
                    <div class="card-body">
                        <form id="form_cadastro">
                        <div class="row">
        
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="nome" class="form-label">Nome Completo:</label>
                                <input type="text" id="nome" name="nome" class="form-control">
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email:</label>
                                <input type="email" id="email" name="email" class="form-control">
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="mb-3">
                                <label for="usuario" class="form-label">Usuário:</label>
                                <input type="text" id="usuario" name="usuario" class="form-control">
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="mb-3">
                                <label for="senha" class="form-label">Senha:</label>
                                <input type="password" id="senha" name="senha" class="form-control">
                            </div>
                        </div>

                        <div class="col-4">
                            <div class="mb-3">
                                <label for="cargo" class="form-label">Cargo:</label>
                                <select class="form-control select2" name="cargo" id="cargo" data-toggle="select2">
                                    <option></option>
                                    <option value="1">Gerente</option>
                                    <option value="2">Cordenador</option>
                                    <option value="3">Produtor</option>
                                    <option value="4">Redator</option>
                                    <option value="5">Designer</option>
                                    <option value="6">Externo</option>
                                    
                                </select>
                            </div>
                        </div>
   
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="unidade" class="form-label">Unidade:</label>
                                <select class="form-control select2" name="unidade" id="unidade" data-toggle="select2">
                                    <option></option>
                                    <option value="1">EFG</option>
                                    <option value="2">COTEC</option>
                                    <option value="3">CETT</option>
                                    <option value="4">BASILEU</option>
                                    <option value="5">EXTERNO</option>
                                    <option value="6">GERAL</option>

                                    
                                </select>
                            </div>
                        </div>

                        <div class="col-9">
                          
                        </div>


                        <div class="col-12">
            
                                <button onclick="cadastrarUsuario()" type="button" class="btn btn-info form-control"><i class="ri-pencil-fill"></i> CADASTRAR</button>
                     
                        </div>
                       
                    </div>
                </form>
                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div>

            <div class="col-md-12">
                <div class="card">
                    <h5 class="card-header bg-info-subtle">Dados dos Usuários</h5>
                    <div class="card-body">
                        <div class="row">

                            <table id="scroll-vertical-datatable" class="table table-striped dt-responsive nowrap w-100">
                                <thead>
                                    <tr>
                                        <th>Cargo</th>
                                        <th>Foto</th>
                                        <th>Nome</th>
                                        <th>Usuário</th>
                                        <th>Email</th>
                                        <th>Unidade</th>
                                    </tr>
                                </thead>
                            
                            
                                <tbody id="tbl_usuarios">
                                    {% for usuario in usuarios %}
                                    <tr onclick="OpenModalUser('{{usuario.id}}')" style="cursor: pointer;">
                                       <td>
                                        {% if usuario.perfil.cargo == 1 %}
                                            <span class="badge bg-primary text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% elif usuario.perfil.cargo == 2 %}
                                            <span class="badge bg-secondary text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% elif usuario.perfil.cargo == 3 %}
                                            <span class="badge bg-success text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% elif usuario.perfil.cargo == 4 %}
                                            <span class="badge bg-danger text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% elif usuario.perfil.cargo == 5 %}
                                            <span class="badge bg-warning text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% elif usuario.perfil.cargo == 6 %}
                                            <span class="badge bg-info text-light">{{usuario.perfil.get_cargo_display}}</span>
                                        {% else %}
                                            <span class="badge bg-dark text-light">Cargo Não Informado</span>
                                        {% endif %}
                                        </td>
                                       <td>
                                        {% if usuario.perfil.foto %}
                                        <img src="{{usuario.perfil.foto}}" id="avatar_topo" alt="user-image" width="36" height="36" class="rounded-circle">
                                        {% else %}
                                        <img src="https://ui-avatars.com/api/?name={{usuario.first_name}}&color=7F9CF5&background=EBF4FF" id="avatar_topo" alt="user-image" width="36" height="36" class="rounded-circle">
                                        {% endif %}
                                        </td>
                                       <td>{{usuario.first_name}}</td>
                                       <td>{{usuario.username}}</td>
                                       <td>{{usuario.email}}</td>
                                       <td>
                                        {% if usuario.perfil.und == 1 or usuario.perfil.und == 6 %}
                                            <span class="badge bg-primary text-light">{{usuario.perfil.get_und_display}}</span>
                                        {% elif usuario.perfil.und == 2 %}
                                            <span class="badge bg-secondary text-light">{{usuario.perfil.get_und_display}}</span>
                                        {% elif usuario.perfil.und == 3 %}
                                            <span class="badge bg-success text-light">{{usuario.perfil.get_und_display}}</span>
                                        {% elif usuario.perfil.und == 4 %}
                                            <span class="badge bg-danger text-light">{{usuario.perfil.get_und_display}}</span>
                                        {% elif usuario.perfil.und == 5  %}
                                            <span class="badge bg-warning text-light">{{usuario.perfil.get_und_display}}</span>
                                        {% else %}
                                            <span class="badge bg-dark text-light">Unidade Não Informada</span>
                                        {% endif %}
                                        
                                    </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>       


                       
                    </div>

                    </div> <!-- end card-body-->
                </div> <!-- end card-->
            </div>
            <!-- end row-->
            
        </div> <!-- container -->

    </div> <!-- content -->

    <div class="modal fade" id="bs-example-modal-lg"  aria-labelledby="myLargeModalLabel" style="display: none;" aria-hidden="true">
      
    </div>

    <!-- Footer Start -->
    <footer class="footer">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <script>document.write(new Date().getFullYear())</script> © CETT - Comunicação
                </div>
                
            </div>
        </div>
    </footer>
    <!-- end Footer -->

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<script>
function OpenModalUser(user_id){
    const url = '/ajax/modal-user';

    $.ajax({
        url,
        type: 'GET',
        data: { 'user_id': user_id },
        success: function(data) {
            $("#bs-example-modal-lg").html(data);
            $("#bs-example-modal-lg").modal('show');
            
        },
        error: function(xhr, status, error) {
            Swal.fire({
                icon: 'error',
                title: 'Ops!',
                text: 'Não conseguimos encontrar este Usuário!'
            });
        }
    });
}

function cadastrarUsuario(){
    var form = document.getElementById("form_cadastro");
    var formData = new FormData(form);

    Swal.fire({
        title: 'Cadastrar Usuário?',
        text: 'Deseja cadastrar um novo usuário?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim',
        cancelButtonText: 'Não'
    }).then((result) => {
        if (result.isConfirmed) {
            var XCSRFToken = '{{ csrf_token }}';
            const url = "/cadastrar-usuario";
            
            // Use a função $.ajax do jQuery para fazer a solicitação AJAX
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                headers: { "X-CSRFToken": XCSRFToken },
                processData: false,  // Não processar os dados (o FormData já cuida disso)
                contentType: false,  // Não definir o tipo de conteúdo (o FormData já cuida disso)
                success: function (data) {
                  $("#tbl_usuarios").html(data);
                    Swal.fire({
                        icon: 'success',
                        title: 'Usuario Criado!',
                        text: "Usuário foi criado com sucesso!"
                    }).then((result) => {
                        // Ação a ser realizada após o botão "OK" ser clicado
                    
                    });
                },
                error: function (data) {
                        console.log(data)
                        Swal.fire({
                            icon: 'error',
                            title: 'Ops!',
                            text: data.responseJSON.erro
                        });
                   
                }
            });
        }
    });

};

function alterarUsuario(user_id){
    var form = document.getElementById("form_altera_cadastro");
    var formData = new FormData(form);
    formData.append('user_id', user_id);
    Swal.fire({
        title: 'Alterar Usuário?',
        text: 'Deseja alterar este usuário?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim',
        cancelButtonText: 'Não'
    }).then((result) => {
        if (result.isConfirmed) {
            var XCSRFToken = '{{ csrf_token }}';
            const url = "/altera-usuario";
            
            // Use a função $.ajax do jQuery para fazer a solicitação AJAX
            $.ajax({
                url: url,
                type: "POST",
                data: formData,
                headers: { "X-CSRFToken": XCSRFToken },
                processData: false,  // Não processar os dados (o FormData já cuida disso)
                contentType: false,  // Não definir o tipo de conteúdo (o FormData já cuida disso)
                success: function (data) {
                  $("#tbl_usuarios").html(data);
                    Swal.fire({
                        icon: 'success',
                        title: 'Usuario Alterado!',
                        text: "Usuário foi alterado com sucesso!"
                    }).then((result) => {
                        // Ação a ser realizada após o botão "OK" ser clicado
                    
                    });
                },
                error: function (data) {
                        console.log(data)
                        Swal.fire({
                            icon: 'error',
                            title: 'Ops!',
                            text: data.responseJSON.erro
                        });
                   
                }
            });
        }
    });
}


</script>


{% endblock %}